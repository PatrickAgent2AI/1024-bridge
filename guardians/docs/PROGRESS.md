# Guardian 模块 - 开发与测试进度

> **文档版本**: v1.0  
> **创建日期**: 2025-11-09  
> **最后更新**: 2025-11-09  
> **子模块**: guardians  
> **父模块**: newlife 跨链桥项目  
> **维护者**: Guardian开发团队

---

## 📋 目录

1. [模块里程碑](#1-模块里程碑)
2. [开发进度追踪](#2-开发进度追踪)
3. [测试进度追踪](#3-测试进度追踪)
4. [问题跟踪](#4-问题跟踪)
5. [性能指标](#5-性能指标)
6. [下周计划](#6-下周计划)

---

## 1. 模块里程碑

### 1.1 总体进度

```
Guardian模块完成度: 0% ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

阶段划分:
├── Phase 1: 架构设计 ✅ 100%
├── Phase 2: P2P网络开发 ⏳ 0%
├── Phase 3: 链监听器开发 ⏳ 0%
├── Phase 4: 签名聚合开发 ⏳ 0%
├── Phase 5: REST API开发 ⏳ 0%
├── Phase 6: 集成测试 ⏳ 0%
└── Phase 7: 性能优化 ⏳ 0%
```

### 1.2 里程碑时间表

| 里程碑 | 计划开始 | 计划完成 | 实际完成 | 状态 | 完成度 |
|--------|---------|---------|---------|------|--------|
| **M1: 架构设计** | 2025-11-01 | 2025-11-09 | 2025-11-09 | ✅ 完成 | 100% |
| **M2: P2P网络** | 2025-12-09 | 2025-12-20 | - | 📅 未开始 | 0% |
| **M3: 链监听器** | 2025-12-11 | 2025-12-27 | - | 📅 未开始 | 0% |
| **M4: 签名聚合** | 2025-12-23 | 2026-01-03 | - | 📅 未开始 | 0% |
| **M5: REST API** | 2026-01-06 | 2026-01-10 | - | 📅 未开始 | 0% |
| **M6: 集成测试** | 2026-01-13 | 2026-01-17 | - | 📅 未开始 | 0% |
| **M7: 性能优化** | 2026-01-20 | 2026-01-24 | - | 📅 未开始 | 0% |

**当前阶段**: M1 - 架构设计  
**下个里程碑**: M2 - P2P网络 (预计 2025-12-09 开始)

---

## 2. 开发进度追踪

### 2.1 Phase 1: 架构设计 ✅ 已完成

**时间**: 2025-11-01 ~ 2025-11-09 (9天)  
**完成度**: 100%

#### 已完成任务

- [x] Guardian架构设计
- [x] P2P网络协议选型 (libp2p + Gossipsub)
- [x] 数据库Schema设计 (PostgreSQL + Redis)
- [x] REST API接口设计
- [x] 签名流程设计
- [x] Guardian Set管理机制设计
- [x] 配置文件结构设计
- [x] 监控指标定义

#### 交付物

| 文档 | 状态 | 链接 |
|------|------|------|
| API-SPEC.md | ✅ | [查看](./API-SPEC.md) |
| TEST-PLAN.md | ✅ | [查看](./TEST-PLAN.md) |
| PROGRESS.md | ✅ | [查看](./PROGRESS.md) |
| README.md | ✅ | [查看](../README.md) |
| 数据库Schema | ✅ | [查看](../schema.sql) |

---

### 2.2 Phase 2: P2P网络开发 📅 未开始

**计划时间**: 2025-12-09 ~ 2025-12-20 (2周)  
**完成度**: 0%

#### 组件清单

| 组件 | 优先级 | 负责人 | 计划时间 | 状态 | 完成度 |
|------|--------|--------|---------|------|--------|
| **P2P基础框架** | P0 | TBD | Week 1 | 📅 | 0% |
| ├─ libp2p配置 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ PeerId管理 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 连接管理 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 心跳机制 | P1 | TBD | 1天 | 📅 | 0% |
| **Gossipsub实现** | P0 | TBD | Week 2 | 📅 | 0% |
| ├─ Topic订阅 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 消息广播 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 消息接收 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 消息验证 | P0 | TBD | 1天 | 📅 | 0% |
| **白名单鉴权** | P0 | TBD | Week 2 | 📅 | 0% |
| └─ PeerId白名单 | P0 | TBD | 1天 | 📅 | 0% |

#### 详细任务列表

##### Week 1: P2P基础框架 (2025-12-09 ~ 2025-12-13)

- [ ] **Task 2.2.1**: 创建Guardian项目结构
  - 初始化Cargo项目
  - 添加libp2p依赖
  - 配置项目结构
  - 预计时间: 0.5天
  - 负责人: TBD

- [ ] **Task 2.2.2**: 实现libp2p配置
  - 配置Transport层 (TCP + Noise + Mplex)
  - 配置NetworkBehaviour
  - 实现PeerId生成
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.2.3**: 实现连接管理
  - 连接建立
  - 连接维护
  - 重连机制
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.2.4**: 实现心跳机制
  - 定期发送心跳
  - 检测离线节点
  - 自动清理断开连接
  - 预计时间: 1天
  - 负责人: TBD

##### Week 2: Gossipsub与鉴权 (2025-12-16 ~ 2025-12-20)

- [ ] **Task 2.2.5**: 实现Gossipsub Topic
  - 创建observations topic
  - 创建signatures topic
  - 创建vaa_ready topic
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.2.6**: 实现消息广播
  - 序列化消息
  - 发布到Gossipsub
  - 错误处理
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.2.7**: 实现消息接收
  - 订阅Topic
  - 反序列化消息
  - 消息路由
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.2.8**: 实现白名单鉴权
  - 加载Guardian Set
  - PeerId白名单检查
  - 拒绝非白名单连接
  - 预计时间: 1天
  - 负责人: TBD

---

### 2.3 Phase 3: 链监听器开发 📅 未开始

**计划时间**: 2025-12-11 ~ 2025-12-27 (2.5周)  
**完成度**: 0%

#### 组件清单

| 组件 | 优先级 | 负责人 | 计划时间 | 状态 | 完成度 |
|------|--------|--------|---------|------|--------|
| **Watcher基础** | P0 | TBD | Week 1 | 📅 | 0% |
| ├─ 链配置加载 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ RPC连接管理 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 多链并发框架 | P0 | TBD | 1天 | 📅 | 0% |
| **EVM Watcher** | P0 | TBD | Week 1-2 | 📅 | 0% |
| ├─ 事件订阅 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 事件解析 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 确认块等待 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 链重组处理 | P0 | TBD | 2天 | 📅 | 0% |
| **Solana Watcher** | P0 | TBD | Week 2-3 | 📅 | 0% |
| ├─ 日志订阅 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 日志解析 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ Slot确认 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 错误重试 | P1 | TBD | 1天 | 📅 | 0% |

#### 详细任务列表

##### Week 1: Watcher基础与EVM (2025-12-11 ~ 2025-12-17)

- [ ] **Task 2.3.1**: 实现链配置加载
  - 读取config.toml
  - 解析链配置
  - 验证配置有效性
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.2**: 实现RPC连接管理
  - 连接池管理
  - 自动重连
  - 负载均衡
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.3**: 实现EVM事件订阅
  - 创建事件过滤器
  - 订阅LogMessagePublished
  - 处理新区块
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.4**: 实现EVM事件解析
  - 解析事件参数
  - 构造Observation
  - 数据验证
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.5**: 实现确认块等待
  - 获取最新区块号
  - 计算确认数
  - 等待逻辑
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.6**: 实现链重组处理
  - 检测区块回滚
  - 清除旧观察记录
  - 重新处理新区块
  - 预计时间: 2天
  - 负责人: TBD

##### Week 2-3: Solana Watcher (2025-12-18 ~ 2025-12-27)

- [ ] **Task 2.3.7**: 实现Solana日志订阅
  - 订阅程序日志
  - 处理日志更新
  - 错误处理
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.8**: 实现Solana日志解析
  - 正则匹配MessagePublished
  - 解析日志参数
  - 地址格式转换
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.9**: 实现Slot确认
  - 获取确认Slot
  - 等待确认逻辑
  - 预计时间: 1天
  - 负责人: TBD

- [ ] **Task 2.3.10**: 实现错误重试
  - RPC错误检测
  - 指数退避重试
  - 告警机制
  - 预计时间: 1天
  - 负责人: TBD

---

### 2.4 Phase 4: 签名聚合开发 📅 未开始

**计划时间**: 2025-12-23 ~ 2026-01-03 (2周)  
**完成度**: 0%

#### 组件清单

| 组件 | 优先级 | 负责人 | 计划时间 | 状态 | 完成度 |
|------|--------|--------|---------|------|--------|
| **签名生成** | P0 | TBD | Week 1 | 📅 | 0% |
| ├─ ECDSA签名 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 观察记录哈希 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 私钥管理 | P0 | TBD | 1天 | 📅 | 0% |
| **签名验证** | P0 | TBD | Week 1 | 📅 | 0% |
| ├─ 签名恢复 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ Guardian Set验证 | P0 | TBD | 1天 | 📅 | 0% |
| └─ 错误签名拒绝 | P0 | TBD | 1天 | 📅 | 0% |
| **签名聚合** | P0 | TBD | Week 2 | 📅 | 0% |
| ├─ 签名收集 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 门限检测 | P0 | TBD | 1天 | 📅 | 0% |
| └─ VAA构造 | P0 | TBD | 2天 | 📅 | 0% |

#### 详细任务列表

- [ ] **Task 2.4.1**: 实现ECDSA签名
  - 使用secp256k1库
  - 签名生成函数
  - 签名格式转换
  - 预计时间: 1天

- [ ] **Task 2.4.2**: 实现观察记录哈希
  - Keccak256哈希
  - 数据序列化
  - 确定性保证
  - 预计时间: 1天

- [ ] **Task 2.4.3**: 实现签名验证
  - ecrecover实现
  - Guardian Set查询
  - 地址比对
  - 预计时间: 1天

- [ ] **Task 2.4.4**: 实现签名聚合逻辑
  - 签名收集器
  - 门限检测
  - VAA生成
  - 预计时间: 2天

---

### 2.5 Phase 5: REST API开发 📅 未开始

**计划时间**: 2026-01-06 ~ 2026-01-10 (1周)  
**完成度**: 0%

#### 组件清单

| 组件 | 优先级 | 负责人 | 计划时间 | 状态 | 完成度 |
|------|--------|--------|---------|------|--------|
| **Axum框架搭建** | P0 | TBD | Day 1 | 📅 | 0% |
| **查询接口** | P0 | TBD | Day 2-3 | 📅 | 0% |
| ├─ GET /v1/signed_vaa | P0 | TBD | 1天 | 📅 | 0% |
| ├─ GET /v1/vaa/status | P0 | TBD | 0.5天 | 📅 | 0% |
| └─ GET /v1/guardian/health | P0 | TBD | 0.5天 | 📅 | 0% |
| **监控接口** | P1 | TBD | Day 4 | 📅 | 0% |
| └─ GET /v1/guardian/metrics | P1 | TBD | 1天 | 📅 | 0% |
| **管理接口** | P1 | TBD | Day 5 | 📅 | 0% |
| ├─ POST /v1/admin/guardian/sign | P1 | TBD | 0.5天 | 📅 | 0% |
| └─ POST /v1/admin/config/reload | P1 | TBD | 0.5天 | 📅 | 0% |

---

### 2.6 Phase 6: 数据库层 📅 未开始

**计划时间**: 与Phase 2-5并行开发  
**完成度**: 0%

#### 组件清单

| 组件 | 优先级 | 负责人 | 计划时间 | 状态 | 完成度 |
|------|--------|--------|---------|------|--------|
| **PostgreSQL集成** | P0 | TBD | Week 1 | 📅 | 0% |
| ├─ Schema设计 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ 连接池 | P0 | TBD | 1天 | 📅 | 0% |
| ├─ CRUD操作 | P0 | TBD | 2天 | 📅 | 0% |
| └─ 事务管理 | P0 | TBD | 1天 | 📅 | 0% |
| **Redis集成** | P1 | TBD | Week 2 | 📅 | 0% |
| ├─ 缓存VAA | P1 | TBD | 1天 | 📅 | 0% |
| ├─ 缓存签名计数 | P1 | TBD | 1天 | 📅 | 0% |
| └─ 缓存过期策略 | P1 | TBD | 1天 | 📅 | 0% |

**数据库Schema** (schema.sql):
```sql
-- Guardian Set表
CREATE TABLE guardian_sets (
    index INTEGER PRIMARY KEY,
    keys BYTEA[] NOT NULL,  -- Guardian地址数组
    creation_time BIGINT NOT NULL,
    expiration_time INTEGER NOT NULL  -- 0表示active
);

-- 观察记录表
CREATE TABLE observations (
    observation_id SERIAL PRIMARY KEY,
    message_hash BYTEA NOT NULL UNIQUE,
    tx_hash BYTEA NOT NULL,
    block_number BIGINT NOT NULL,
    block_timestamp INTEGER NOT NULL,
    emitter_chain SMALLINT NOT NULL,
    emitter_address BYTEA NOT NULL,
    sequence BIGINT NOT NULL,
    nonce INTEGER NOT NULL,
    payload BYTEA NOT NULL,
    consistency_level SMALLINT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_emitter (emitter_chain, emitter_address, sequence)
);

-- 签名表
CREATE TABLE signatures (
    signature_id SERIAL PRIMARY KEY,
    message_hash BYTEA NOT NULL,
    guardian_index SMALLINT NOT NULL,
    signature BYTEA NOT NULL,  -- 65字节 (r, s, v)
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (message_hash) REFERENCES observations(message_hash),
    UNIQUE (message_hash, guardian_index)
);

-- VAA表
CREATE TABLE vaas (
    vaa_id SERIAL PRIMARY KEY,
    message_hash BYTEA NOT NULL UNIQUE,
    vaa_bytes BYTEA NOT NULL,
    guardian_set_index INTEGER NOT NULL,
    signature_count SMALLINT NOT NULL,
    status VARCHAR(20) NOT NULL,  -- 'pending', 'ready', 'consumed'
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (message_hash) REFERENCES observations(message_hash)
);

-- 索引
CREATE INDEX idx_signatures_message ON signatures(message_hash);
CREATE INDEX idx_vaas_status ON vaas(status);
CREATE INDEX idx_observations_chain ON observations(emitter_chain);
```

---

### 2.7 进度统计

**总任务数**: 45  
**已完成**: 8 (架构设计)  
**进行中**: 0  
**待开始**: 37  
**完成率**: 17.8%

---

## 3. 测试进度追踪

### 3.1 测试总览

**总测试用例**: 88个  
**已完成**: 88个  
**进行中**: 0个  
**待开始**: 0个  
**通过率**: 待运行

```
测试完成度: 100% ████████████████████████████████

分类统计:
├── E2E测试: 6/6 (100%) ✅
├── 集成测试: 32/32 (100%) ✅
└── 单元测试: 50/50 (100%) ✅
```

**最近更新**: 2025-11-09  
**更新内容**: 完成所有测试用例的实现

---

### 3.2 E2E测试进度

| 测试场景 | 优先级 | 预计时间 | 状态 | 完成度 |
|---------|--------|---------|------|--------|
| E2E-G-001: 完整VAA生成流程 | P0 | 15分钟 | ✅ | 100% |
| E2E-G-002: 多链并发监听 | P0 | 10分钟 | ✅ | 100% |
| E2E-G-003: Guardian Set升级 | P0 | 20分钟 | ✅ | 100% |
| E2E-G-004: 高并发测试 | P1 | 15分钟 | ✅ | 100% |
| E2E-G-005: 链重组处理 | P1 | 10分钟 | ✅ | 100% |
| E2E-G-006: 异常恢复 | P1 | 10分钟 | ✅ | 100% |
| **总计** | - | **80分钟** | **✅** | **100%** |

**测试文件**: `tests/e2e_tests.rs`  
**测试数量**: 9个测试函数 (覆盖6个场景)

---

### 3.3 集成测试进度

#### 3.3.1 REST API测试

| 测试用例数 | 已完成 | 通过 | 失败 | 状态 |
|-----------|--------|------|------|------|
| 12 | 12 | 待运行 | 0 | ✅ |

**已实现测试**:
- API-G-001: VAA已就绪,返回200
- API-G-002: VAA聚合中,返回202
- API-G-003: VAA不存在,返回404
- API-G-004: 无效的链ID,返回400
- API-G-005: 无效的地址格式
- API-G-006: 多并发请求
- API-G-007: VAA字节格式验证
- API-G-008: VAA JSON结构验证
- API-G-009: 签名数量验证
- API-G-010: 进度信息验证
- API-G-011: 错误格式验证
- API-G-012: VAA状态查询

#### 3.3.2 链监听器测试

| 测试用例数 | 已完成 | 通过 | 失败 | 状态 |
|-----------|--------|------|------|------|
| 8 | 8 | 待运行 | 0 | ✅ |

**已实现测试**:
- WATCH-G-001: 监听事件
- WATCH-G-002: 等待确认块
- WATCH-G-003: 多个事件处理
- WATCH-G-004: Observation转换
- WATCH-G-005: 区块号追踪
- WATCH-G-006: 并发事件处理
- WATCH-G-007: 不同链处理
- WATCH-G-008: 确认级别验证

#### 3.3.3 P2P网络测试

| 测试用例数 | 已完成 | 通过 | 失败 | 状态 |
|-----------|--------|------|------|------|
| 6 | 6 | 待运行 | 0 | ✅ |

**已实现测试**:
- P2P-G-001: 发布Observation消息
- P2P-G-002: 发布Signature消息
- P2P-G-003: 发布VAAReady消息
- P2P-G-004: 消息顺序保证
- P2P-G-005: 并发发布
- P2P-G-006: 空队列处理

#### 3.3.4 签名验证测试

| 测试用例数 | 已完成 | 通过 | 失败 | 状态 |
|-----------|--------|------|------|------|
| 6 | 6 | 待运行 | 0 | ✅ |

**已实现测试**:
- SIGN-G-001: 签名聚合门限
- SIGN-G-002: VAA构造
- SIGN-G-003: 并发签名聚合
- SIGN-G-004: 有效签名集合验证
- SIGN-G-005: 无效Guardian索引
- SIGN-G-006: 错误消息验证

**测试文件**: `tests/integration_tests.rs`

---

### 3.4 单元测试进度

| 测试类别 | 测试用例数 | 已完成 | 通过 | 失败 | 覆盖率 | 状态 |
|---------|-----------|--------|------|------|--------|------|
| VAA序列化 | 8 | 8 | 待运行 | 0 | 目标90% | ✅ |
| 签名工具 | 6 | 6 | 待运行 | 0 | 目标90% | ✅ |
| 配置加载 | 5 | 5 | 待运行 | 0 | 目标90% | ✅ |
| 数据库操作 | 10 | 10 | 待运行 | 0 | 目标90% | ✅ |
| 地址转换 | 6 | 6 | 待运行 | 0 | 目标90% | ✅ |
| Observation处理 | 5 | 5 | 待运行 | 0 | 目标90% | ✅ |
| Guardian Set | 4 | 4 | 待运行 | 0 | 目标90% | ✅ |
| 工具函数 | 6 | 6 | 待运行 | 0 | 目标90% | ✅ |
| **总计** | **50** | **50** | **待运行** | **0** | **目标90%** | **✅** |

**测试文件**: `tests/unit_tests.rs`  
**测试助手**: `tests/helpers/` (fixtures, mock_chain, vaa_builder)

**详细测试列表**:
- VAA序列化/反序列化: 8个 (含边界情况、大payload、无效数据)
- 签名生成与验证: 6个 (含确定性测试、恢复测试、验证测试)
- 配置加载: 5个 (含链配置、Guardian配置、默认配置)
- 数据库操作: 10个 (含CRUD、并发、状态查询)
- 地址转换: 6个 (含to/from 32字节、以太坊地址、往返转换)
- Observation: 5个 (含哈希、序列化、不同参数)
- Guardian Set: 4个 (含激活状态、过期检查、密钥数量)
- 工具函数: 6个 (含keccak256、Signature转换)

---

## 4. 问题跟踪

### 4.1 当前问题

**总问题数**: 0  
**严重**: 0  
**高**: 0  
**中**: 0  
**低**: 0

| ID | 标题 | 严重度 | 状态 | 负责人 | 创建日期 | 预计解决 |
|----|------|--------|------|--------|---------|---------|
| - | 暂无问题 | - | - | - | - | - |

---

### 4.2 已解决问题

| ID | 标题 | 严重度 | 解决方案 | 解决人 | 解决日期 |
|----|------|--------|---------|--------|---------|
| - | 暂无已解决问题 | - | - | - | - |

---

### 4.3 问题分类统计

```
按严重度:
├── 严重 (Critical): 0
├── 高 (High): 0
├── 中 (Medium): 0
└── 低 (Low): 0

按类型:
├── Bug: 0
├── 性能: 0
├── 安全: 0
└── 文档: 0

按状态:
├── 待处理: 0
├── 进行中: 0
├── 已解决: 0
└── 已关闭: 0
```

---

## 5. 性能指标

### 5.1 开发效率指标

| 指标 | 本周 | 上周 | 趋势 |
|------|------|------|------|
| 代码提交数 | 3 | 0 | ↑ |
| 代码行数 | +500 | 0 | ↑ |
| PR数量 | 0 | 0 | - |
| 代码审查 | 0 | 0 | - |
| 测试用例新增 | 0 | 0 | - |

---

### 5.2 目标性能指标

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| VAA生成时间 | <30秒 | N/A | 📅 |
| API P95延迟 | <100ms | N/A | 📅 |
| P2P消息延迟 | <500ms | N/A | 📅 |
| 数据库查询延迟 | <20ms | N/A | 📅 |
| 签名生成时间 | <100ms | N/A | 📅 |
| 内存使用 | <500MB | N/A | 📅 |
| CPU使用率 | <50% | N/A | 📅 |

---

### 5.3 测试质量指标

| 指标 | 当前值 | 目标值 | 达成率 |
|------|--------|--------|--------|
| 单元测试覆盖率 | 0% | 90% | 0% |
| 集成测试覆盖率 | 0% | 90% | 0% |
| E2E测试覆盖率 | 0% | 100% | 0% |
| 测试通过率 | N/A | 99% | N/A |
| Bug修复时间(平均) | N/A | <1天 | N/A |

---

## 6. 下周计划

### 6.1 当前重点

**注意**: Guardian模块的开发要等到父模块Phase 2(合约开发)完成后才能开始。

**依赖关系**:
- Guardian需要监听合约事件 → 需要合约先部署
- Guardian需要验证VAA格式 → 需要合约定义VAA结构
- Guardian需要对接链 → 需要测试环境就绪

**预计开始时间**: 2025-12-09 (合约开发完成后)

---

### 6.2 准备工作 (2025-11-09 ~ 2025-12-08)

在等待合约开发期间,可以进行以下准备:

#### Week 1-2: 技术调研 (2025-11-09 ~ 2025-11-22)

- [ ] libp2p Rust库学习
  - 阅读官方文档
  - 运行示例代码
  - 理解Gossipsub协议

- [ ] secp256k1签名库学习
  - ECDSA签名生成
  - 签名恢复
  - 性能测试

- [ ] Axum Web框架学习
  - 路由设计
  - 中间件使用
  - 异步处理

#### Week 3-4: 环境搭建 (2025-11-25 ~ 2025-12-06)

- [ ] 开发环境配置
  - 安装Rust工具链
  - 配置IDE (VS Code + rust-analyzer)
  - 配置代码格式化 (rustfmt)

- [ ] 测试环境搭建
  - Docker安装
  - PostgreSQL配置
  - Redis配置

- [ ] CI/CD配置
  - GitHub Actions工作流
  - 测试流水线
  - 代码覆盖率工具

#### Week 4: 项目骨架 (2025-12-02 ~ 2025-12-08)

- [ ] 创建Cargo项目
  - 初始化workspace
  - 添加依赖
  - 配置模块结构

- [ ] 实现基础类型
  - VAA结构体
  - Observation结构体
  - Guardian Set结构体
  - 配置结构体

- [ ] 编写Mock工具
  - Mock链监听器
  - Mock P2P网络
  - Mock数据库

---

### 6.3 Phase 2启动计划 (2025-12-09)

**启动会议议程**:
1. 回顾架构设计
2. 分配开发任务
3. 讨论技术难点
4. 确定开发规范

**第一周目标**:
- 完成P2P网络基础框架
- 实现libp2p配置
- 编写P2P连接测试
- 启动链监听器开发

---

## 7. 团队与资源

### 7.1 团队组成

| 角色 | 人数 | 姓名 | 状态 |
|------|------|------|------|
| Rust开发工程师 | 2 | TBD | 📅 招募中 |
| 测试工程师 | 1 | TBD | 📅 招募中 |
| **总计** | **3** | - | - |

---

### 7.2 资源需求

**开发环境**:
- [x] GitHub仓库
- [ ] CI/CD流水线
- [ ] 测试网RPC节点
- [ ] 数据库服务器

**工具与服务**:
- [x] Rust工具链
- [ ] Docker环境
- [ ] 监控系统 (Prometheus + Grafana)
- [ ] 日志系统 (ELK)

**预算需求**:
- 测试网RPC: $200/月
- 云服务器: $150/月
- 监控服务: $50/月

---

## 8. 风险与缓解

### 8.1 技术风险

| 风险 | 严重度 | 概率 | 缓解措施 |
|------|--------|------|---------|
| **依赖版本冲突** | **高** | **高** | **使用Cargo features隔离、模块化架构、固定版本** |
| libp2p/ethers/solana-client三方依赖冲突 | 高 | 高 | 详见下方"依赖冲突缓解方案" |
| libp2p性能不足 | 高 | 中 | 提前进行性能测试,准备替代方案 |
| 链重组处理复杂 | 中 | 高 | 参考Wormhole实现,充分测试 |
| P2P网络分区 | 中 | 中 | 实现自动恢复机制 |
| 数据库性能瓶颈 | 中 | 低 | 使用Redis缓存,优化SQL查询 |

#### 依赖冲突缓解方案

**问题描述**:
- `solana-client` 依赖特定版本的 `tokio`、`tonic`、`prost`
- `ethers` 也依赖这些库,但版本可能不同
- `libp2p` 有自己的依赖版本要求
- 三者的传递依赖可能产生版本冲突

**缓解策略**:

1. **阶段1: 依赖调研 (Week 1-2)**
   ```bash
   # 创建测试项目验证依赖兼容性
   cargo new --lib guardian-deps-test
   cd guardian-deps-test
   
   # 添加所有依赖
   cargo add libp2p@0.53 ethers@2.0 solana-client@1.17
   
   # 检查冲突
   cargo tree -d
   cargo build -vv
   ```

2. **阶段2: 使用 features 隔离 (Week 3)**
   ```toml
   [features]
   default = []
   evm-watcher = ["ethers"]
   solana-watcher = ["solana-client"]
   p2p = ["libp2p"]
   
   # 允许分别编译测试
   ```

3. **阶段3: 精简模块化架构 (Week 4-5)**
   ```
   guardians/
   ├── guardian-core/      # 核心逻辑 + libp2p (P2P、签名、聚合、存储、API)
   ├── guardian-evm/       # EVM监听器 (ethers)
   ├── guardian-solana/    # Solana监听器 (solana-client)
   └── guardian-bin/       # 主程序,组合所有模块
   ```
   
   **关键点**:
   - guardian-core 包含所有核心功能,依赖 libp2p
   - guardian-evm 只依赖 ethers + guardian-core types
   - guardian-solana 只依赖 solana-client + guardian-core types
   - 通过消息通道 (mpsc) 实现松耦合通信

4. **阶段4: 版本固定与测试 (Week 6)**
   - 确定兼容的版本组合
   - 提交 `Cargo.lock` 到版本控制
   - 编写依赖版本测试脚本
   - CI/CD 中增加依赖检查

5. **备选方案: 进程隔离 (如果冲突无法解决)**
   - 将链监听器作为独立进程
   - 使用 gRPC 或 IPC 通信
   - 容器化部署,完全隔离依赖

**责任人**: Rust开发工程师  
**优先级**: P0 (在开始编码前必须解决)  
**预计时间**: 2周 (与Phase 2并行)

**跟踪指标**:
- [ ] 依赖兼容性测试完成
- [ ] Cargo.toml 配置确定
- [ ] 架构方案选定
- [ ] CI/CD 依赖检查就绪

---

### 8.2 进度风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 合约开发延期 | 高 | Guardian开发相应延期,利用等待时间做准备工作 |
| 团队成员不足 | 高 | 尽快招募,必要时外包部分工作 |
| 技术难点卡住 | 中 | 提前调研,寻求社区帮助 |

---

## 9. 文档更新日志

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2025-11-09 | v1.0 | 初始文档创建,完成Phase 1规划 | Guardian团队 |
| 2025-11-09 | v1.1 | 完成测试套件实现 (88个测试用例) | Guardian团队 |

---

**下次更新**: 2025-11-16 (每周五更新)

---

## 附录

### A. 术语表

| 术语 | 说明 |
|------|------|
| VAA | Verified Action Approval - 已验证的操作批准 |
| Observation | 观察记录 - Guardian观察到的链上事件 |
| Gossipsub | libp2p的消息发布/订阅协议 |
| Guardian Set | Guardian集合及其版本号 |
| Quorum | 签名门限 (13/19) |

---

### B. 快捷链接

- [API规格说明书](./API-SPEC.md)
- [测试套件规划](./TEST-PLAN.md)
- [Guardian README](../README.md)
- [父模块文档](../../docs/)
- [GitHub仓库](https://github.com/your-org/bridge)

---

**文档状态**: ✅ 初版完成  
**维护周期**: 每周五更新

